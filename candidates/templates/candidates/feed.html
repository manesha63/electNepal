{% extends 'base.html' %}
{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}

{% block title %}Discover Candidates - ElectNepal{% endblock %}

{% block extra_css %}
<style>
    /* Override base styles */
    body {
        background: #f5f7fa;
    }
    
    .main-content .container {
        max-width: 100%;
        padding: 0;
    }
    
    /* Top Search Bar */
    .search-header {
        background: transparent;
        padding: 20px;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .search-container {
        max-width: 1000px;
        margin: 0 auto;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .search-bar {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        height: 36px; /* 1.5x previous height (24px * 1.5) */
        width: 874px; /* 2.3x previous width (380px * 2.3) */
        transition: all 0.3s;
        position: relative;
    }
    
    .search-bar:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    .search-icon {
        padding: 0 16px;
        color: #6b7280;
        font-size: 14px;
    }
    
    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 14px;
        padding: 0;
        outline: none;
        height: 100%;
    }
    
    .search-input::placeholder {
        color: #9ca3af;
    }
    
    .search-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 0 20px;
        height: 100%;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        border-radius: 0 3px 3px 0;
    }
    
    .search-btn:hover {
        background: #5a67d8;
    }
    
    /* Main Layout Container */
    .content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Left Column - Candidates Feed */
    .candidates-section {
        min-height: 100vh;
    }
    
    
    /* Candidate Cards Grid */
    .candidates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 40px;
    }
    
    /* Candidate Card */
    .candidate-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .candidate-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .candidate-photo {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        object-fit: cover;
        background: #f3f4f6;
    }
    
    .candidate-photo-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }
    
    .candidate-info {
        flex: 1;
    }
    
    .candidate-name {
        font-weight: 600;
        font-size: 16px;
        color: #111827;
        margin-bottom: 4px;
    }
    
    .candidate-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .detail-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #6b7280;
    }
    
    .detail-row i {
        width: 14px;
        text-align: center;
        color: #9ca3af;
    }
    
    .level-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-federal {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-provincial {
        background: #ede9fe;
        color: #5b21b6;
    }
    
    .badge-local {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .party-label {
        background: #e5e7eb;
        color: #374151;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    /* Card Actions */
    .card-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
    }
    
    .action-btn {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        color: #374151;
    }
    
    .action-btn:hover {
        background: #f9fafb;
        border-color: #667eea;
        color: #667eea;
    }
    
    .action-btn.primary {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .action-btn.primary:hover {
        background: #5b67d8;
    }
    
    /* Filter Button and Dropdown */
    .filter-button {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 0 16px;
        height: 36px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        color: #374151;
        position: relative;
    }
    
    .filter-button:hover {
        border-color: #667eea;
        background: #f9fafb;
    }
    
    .filter-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        min-width: 280px;
        z-index: 200;
        display: none;
    }
    
    .filter-dropdown.active {
        display: block;
    }
    
    .filter-wrapper {
        position: relative;
    }
    
    .filter-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 16px;
        color: #111827;
    }
    
    .filter-group {
        margin-bottom: 20px;
    }
    
    .filter-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
    }
    
    .filter-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .filter-select:disabled {
        background: #f9fafb;
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .clear-filters-btn {
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .clear-filters-btn:hover {
        background: #e5e7eb;
    }

    /* Province options hover effect */
    .province-option:hover {
        background: #f3f4f6;
    }

    /* Mobile Filter Button */
    .mobile-filter-btn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        cursor: pointer;
        z-index: 99;
        align-items: center;
        justify-content: center;
    }
    
    /* Mobile Filter Drawer */
    .filter-drawer {
        display: none;
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        max-width: 320px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 12px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: right 0.3s;
        overflow-y: auto;
    }
    
    .filter-drawer.open {
        right: 0;
    }
    
    .drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .drawer-title {
        font-weight: 600;
        font-size: 18px;
    }
    
    .drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
    }
    
    .drawer-body {
        padding: 20px;
    }
    
    /* Loading State */
    .loading-skeleton {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        margin: 20px 0;
    }
    
    .empty-icon {
        font-size: 48px;
        color: #e5e7eb;
        margin-bottom: 16px;
    }
    
    .empty-title {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
    }
    
    .empty-desc {
        color: #6b7280;
        margin-bottom: 20px;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 40px 0;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 40px;
        text-align: center;
    }
    
    .page-btn:hover {
        border-color: #667eea;
        background: #f9fafb;
    }
    
    .page-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
        .content-wrapper {
            grid-template-columns: 1fr;
        }
        
        .filters-sidebar {
            display: none;
        }
        
        .mobile-filter-btn {
            display: flex;
        }
    }
    
    @media (max-width: 640px) {
        .candidates-grid {
            grid-template-columns: 1fr;
        }
        
        .search-header {
            padding: 12px;
        }
        
        .content-wrapper {
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Search Header -->
<div class="search-header">
    <div class="search-container">
        <div class="search-bar">
            <div class="search-icon">
                <i class="fas fa-search"></i>
            </div>
            <input type="text" 
                   id="searchInput" 
                   class="search-input" 
                   placeholder="{% trans 'Search candidates...' %}"
                   value="{{ request.GET.q }}">
            <button class="search-btn" onclick="performSearch()">
                {% trans 'Search' %}
            </button>
        </div>
        
        <!-- Filter Button -->
        <div class="filter-wrapper">
            <button class="filter-button" onclick="toggleFilterDropdown()">
                <i class="fas fa-filter"></i>
            </button>
            
            <!-- Filter Dropdown -->
            <div id="filterDropdown" class="filter-dropdown">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">{% trans 'Filter Candidates' %}</h3>

                <!-- Row 1: Federal -->
                <div class="filter-group" style="margin-bottom: 12px;">
                    <button id="federalFilter" class="filter-select" onclick="onFederalClick()"
                            data-label="{% trans 'Federal' %}"
                            style="width: 100%; text-align: left; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        <span id="federalText">{% trans 'Federal' %}</span>
                    </button>
                </div>

                <!-- Row 2: Province and District -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <div style="flex: 1; position: relative;">
                        <button id="provinceButton" class="filter-select" onclick="toggleProvinceDropdown()"
                                data-label="{% trans 'Province' %}"
                                data-all="{% trans 'All' %}"
                                style="width: 100%; text-align: left; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                            <span id="provinceText">{% trans 'Province' %}</span>
                        </button>
                        <!-- Province dropdown menu -->
                        <div id="provinceDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 140%; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="padding: 8px;">
                                <div class="province-option" onclick="selectProvince('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px;">
                                    <strong>{% trans 'All' %}</strong>
                                </div>
                                {% get_current_language as LANGUAGE_CODE %}
                                {% for province in provinces %}
                                <div class="province-option" onclick="selectProvince('{{ province.id }}', '{% if LANGUAGE_CODE == 'ne' %}{{ province.name_ne }}{% else %}{{ province.name_en }}{% endif %}')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 2px;">
                                    {% if LANGUAGE_CODE == 'ne' %}{{ province.name_ne }}{% else %}{{ province.name_en }}{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; position: relative;">
                        <button id="districtButton" class="filter-select" onclick="toggleDistrictDropdown()"
                                data-label="{% trans 'District' %}"
                                data-all="{% trans 'All Districts' %}"
                                style="width: 100%; text-align: left; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                            <span id="districtText">{% trans 'District' %}</span>
                        </button>
                        <!-- District dropdown menu -->
                        <div id="districtDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 140%; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto;">
                            <div style="padding: 8px;">
                                <div id="districtOptions">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Municipality and Ward -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <div style="flex: 1; position: relative;">
                        <button id="municipalityButton" class="filter-select" onclick="toggleMunicipalityDropdown()"
                                data-label="{% trans 'Municipality' %}"
                                data-all="{% trans 'All Municipalities' %}"
                                style="width: 100%; text-align: left; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                            <span id="municipalityText">{% trans 'Municipality' %}</span>
                        </button>
                        <!-- Municipality dropdown menu -->
                        <div id="municipalityDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 140%; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto;">
                            <div style="padding: 8px;">
                                <div id="municipalityOptions">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; position: relative;">
                        <button id="wardButton" class="filter-select" onclick="toggleWardDropdown()"
                                data-label="{% trans 'Ward' %}"
                                data-all="{% trans 'All Wards' %}"
                                data-ward-prefix="{% trans 'Ward' %}"
                                style="width: 100%; text-align: left; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                            <span id="wardText">{% trans 'Ward' %}</span>
                        </button>
                        <!-- Ward dropdown menu -->
                        <div id="wardDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 140%; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto;">
                            <div style="padding: 8px;">
                                <div id="wardOptions">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="clear-filters-btn" onclick="clearAllFilters()" style="width: 100%;">
                    <i class="fas fa-times"></i> {% trans 'Clear' %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="content-wrapper">
    <!-- Left Column - Candidates -->
    <div class="candidates-section">
        
        <!-- Candidates Grid -->
        <div id="candidatesGrid" class="candidates-grid">
            <!-- Candidates will be loaded here -->
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3 class="empty-title">No candidates found</h3>
            <p class="empty-desc">Try adjusting your filters or search terms</p>
            <button class="clear-filters-btn" onclick="clearAllFilters()">Clear</button>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="pagination">
            <!-- Pagination buttons will be loaded here -->
        </div>
    </div>
    
</div>

<!-- Mobile Filter Button -->
<button class="mobile-filter-btn" onclick="openFilterDrawer()">
    <i class="fas fa-filter"></i>
</button>

<!-- Mobile Filter Drawer -->
<div id="filterDrawer" class="filter-drawer">
    <div class="drawer-header">
        <h3 class="drawer-title">Filters</h3>
        <button class="drawer-close" onclick="closeFilterDrawer()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="drawer-body">
        <!-- Duplicate filters for mobile -->
        <div class="filter-group">
            <label class="filter-label">Province</label>
            <select id="mobileProvinceFilter" class="filter-select" onchange="onProvinceChange(true)">
                <option value="">All Provinces</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">District</label>
            <select id="mobileDistrictFilter" class="filter-select" onchange="onDistrictChange(true)" disabled>
                <option value="">Select Province First</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Municipality</label>
            <select id="mobileMunicipalityFilter" class="filter-select" onchange="onMunicipalityChange(true)" disabled>
                <option value="">Select District First</option>
            </select>
        </div>
        
        <button class="clear-filters-btn" onclick="clearLocationFilters(); closeFilterDrawer();">
            Clear Filters
        </button>
    </div>
</div>

<script>
// Get current language from Django
{% get_current_language as LANGUAGE_CODE %}
const currentLanguage = "{{ LANGUAGE_CODE }}";

// Translation strings
const translations = {
    all: "{% trans 'All' %}",
    allProvinces: "{% trans 'All Provinces' %}",
    allDistricts: "{% trans 'All Districts' %}",
    allDistrictsInProvince: "{% trans 'All Districts in Province' %}",
    allMunicipalities: "{% trans 'All Municipalities' %}",
    allMunicipalitiesInDistrict: "{% trans 'All Municipalities in District' %}",
    allWards: "{% trans 'All Wards' %}",
    ward: "{% trans 'Ward' %}",
    selectProvince: "{% trans 'Select Province' %}",
    selectDistrict: "{% trans 'Select District' %}",
    selectMunicipality: "{% trans 'Select Municipality' %}",
    selectProvinceFirst: "{% trans 'Select Province First' %}",
    selectDistrictFirst: "{% trans 'Select District First' %}",
    selectProvinceDistrictFirst: "{% trans 'Select province and district first to see specific municipalities' %}",
    selectProvDistMuniFirst: "{% trans 'Select province, district, and municipality first to see wards' %}",
    // Candidate card translations
    seat: "{% trans 'Seat' %}",
    openProfile: "{% trans 'Open Profile' %}",
    share: "{% trans 'Share' %}",
    provincial: "{% trans 'provincial' %}",
    local: "{% trans 'local' %}",
    federal: "{% trans 'federal' %}",
    independent: "{% trans 'Independent' %}",
    na: "{% trans 'N/A' %}"
};

// Helper function to set button text
function setButtonText(buttonId, text) {
    const button = document.getElementById(buttonId);
    const span = button.querySelector('span');
    if (span) {
        span.textContent = text;
    } else {
        button.textContent = text;
    }
}

// Helper function to get default label from data attribute
function getDefaultLabel(buttonId) {
    const button = document.getElementById(buttonId);
    return button.dataset.label || button.textContent;
}

// State Management
const state = {
    candidates: [],
    filters: {
        positionLevel: '',
        provinceId: '',
        districtId: '',
        municipalityId: '',
        wardNumber: '',
        q: '',
        page: 1
    },
    selectedMunicipality: null,  // Store selected municipality data
    isLoading: false,
    debounceTimer: null
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeFromURL();
    loadProvinces();
    loadCandidates();
    setupSearchDebounce();
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        // Close filter dropdown
        const filterWrapper = document.querySelector('.filter-wrapper');
        const filterDropdown = document.getElementById('filterDropdown');
        if (!filterWrapper.contains(e.target)) {
            filterDropdown.classList.remove('active');
        }

        // Close province dropdown
        const provinceButton = document.getElementById('provinceButton');
        const provinceDropdown = document.getElementById('provinceDropdown');
        if (provinceDropdown && provinceDropdown.style.display === 'block') {
            if (!provinceButton.contains(e.target) && !provinceDropdown.contains(e.target)) {
                provinceDropdown.style.display = 'none';
            }
        }

        // Close district dropdown
        const districtButton = document.getElementById('districtButton');
        const districtDropdown = document.getElementById('districtDropdown');
        if (districtDropdown && districtDropdown.style.display === 'block') {
            if (!districtButton.contains(e.target) && !districtDropdown.contains(e.target)) {
                districtDropdown.style.display = 'none';
            }
        }

        // Close municipality dropdown
        const municipalityButton = document.getElementById('municipalityButton');
        const municipalityDropdown = document.getElementById('municipalityDropdown');
        if (municipalityDropdown && municipalityDropdown.style.display === 'block') {
            if (!municipalityButton.contains(e.target) && !municipalityDropdown.contains(e.target)) {
                municipalityDropdown.style.display = 'none';
            }
        }

        // Close ward dropdown
        const wardButton = document.getElementById('wardButton');
        const wardDropdown = document.getElementById('wardDropdown');
        if (wardDropdown && wardDropdown.style.display === 'block') {
            if (!wardButton.contains(e.target) && !wardDropdown.contains(e.target)) {
                wardDropdown.style.display = 'none';
            }
        }
    });
});

// Toggle filter dropdown
function toggleFilterDropdown() {
    const dropdown = document.getElementById('filterDropdown');
    dropdown.classList.toggle('active');
}

// Parse URL parameters
function initializeFromURL() {
    const params = new URLSearchParams(window.location.search);
    state.filters = {
        positionLevel: params.get('positionLevel') || '',
        provinceId: params.get('provinceId') || '',
        districtId: params.get('districtId') || '',
        municipalityId: params.get('municipalityId') || '',
        wardNumber: params.get('wardNumber') || '',
        q: params.get('q') || '',
        page: parseInt(params.get('page')) || 1
    };

    // Update UI to match URL state
    if (state.filters.q) {
        document.getElementById('searchInput').value = state.filters.q;
    }
    if (state.filters.positionLevel) {
        // Check the appropriate radio button
        const radio = document.querySelector(`input[name="positionLevel"][value="${state.filters.positionLevel}"]`);
        if (radio) {
            radio.checked = true;
            onPositionChange(state.filters.positionLevel);
        }
    }
}

// Update URL with current filters
function updateURL() {
    const params = new URLSearchParams();
    Object.keys(state.filters).forEach(key => {
        if (state.filters[key] && state.filters[key] !== 'all') {
            params.set(key, state.filters[key]);
        }
    });
    
    const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
    window.history.pushState({}, '', newURL);
}

// Load provinces
async function loadProvinces() {
    try {
        const response = await fetch('/api/districts/');
        const provinces = await response.json();
        
        // Populate province selects
        const provinceOptions = provinces.map(p => 
            `<option value="${p.id}">${p.name_en}</option>`
        ).join('');
        
        // Add to desktop filter
        const desktopSelect = document.getElementById('provinceFilter');
        if (desktopSelect) {
            desktopSelect.innerHTML = `<option value="">${translations.allProvinces}</option>` + provinceOptions;
            if (state.filters.provinceId) {
                desktopSelect.value = state.filters.provinceId;
                loadDistricts(state.filters.provinceId);
            }
        }
        
        // Add to mobile filter
        const mobileSelect = document.getElementById('mobileProvinceFilter');
        if (mobileSelect) {
            mobileSelect.innerHTML = `<option value="">${translations.allProvinces}</option>` + provinceOptions;
            if (state.filters.provinceId) {
                mobileSelect.value = state.filters.provinceId;
            }
        }
    } catch (error) {
        console.error('Error loading provinces:', error);
    }
}

// Load districts for selected province
async function loadDistricts(provinceId) {
    if (!provinceId) {
        resetDistrictSelect();
        return;
    }
    
    try {
        const response = await fetch(`/api/districts/?province=${provinceId}`);
        const districts = await response.json();
        
        const districtOptions = districts.map(d =>
            `<option value="${d.id}">${currentLanguage === 'ne' ? d.name_ne : d.name_en}</option>`
        ).join('');
        
        // Update desktop filter
        const desktopSelect = document.getElementById('districtFilter');
        if (desktopSelect) {
            desktopSelect.innerHTML = `<option value="">${translations.allDistricts}</option>` + districtOptions;
            desktopSelect.disabled = false;
            if (state.filters.districtId) {
                desktopSelect.value = state.filters.districtId;
                loadMunicipalities(state.filters.districtId);
            }
        }
        
        // Update mobile filter
        const mobileSelect = document.getElementById('mobileDistrictFilter');
        if (mobileSelect) {
            mobileSelect.innerHTML = `<option value="">${translations.allDistricts}</option>` + districtOptions;
            mobileSelect.disabled = false;
            if (state.filters.districtId) {
                mobileSelect.value = state.filters.districtId;
            }
        }
    } catch (error) {
        console.error('Error loading districts:', error);
    }
}

// Load municipalities for selected district
async function loadMunicipalities(districtId) {
    if (!districtId) {
        resetMunicipalitySelect();
        return;
    }
    
    try {
        const response = await fetch(`/api/municipalities/?district=${districtId}`);
        const municipalities = await response.json();
        
        const municipalityOptions = municipalities.map(m =>
            `<option value="${m.id}">${currentLanguage === 'ne' ? m.name_ne : m.name_en}</option>`
        ).join('');
        
        // Update desktop filter
        const desktopSelect = document.getElementById('municipalityFilter');
        if (desktopSelect) {
            desktopSelect.innerHTML = `<option value="">${translations.allMunicipalities}</option>` + municipalityOptions;
            desktopSelect.disabled = false;
            if (state.filters.municipalityId) {
                desktopSelect.value = state.filters.municipalityId;
            }
        }
        
        // Update mobile filter
        const mobileSelect = document.getElementById('mobileMunicipalityFilter');
        if (mobileSelect) {
            mobileSelect.innerHTML = `<option value="">${translations.allMunicipalities}</option>` + municipalityOptions;
            mobileSelect.disabled = false;
            if (state.filters.municipalityId) {
                mobileSelect.value = state.filters.municipalityId;
            }
        }
    } catch (error) {
        console.error('Error loading municipalities:', error);
    }
}

// Reset district select
function resetDistrictSelect() {
    const selects = ['districtFilter', 'mobileDistrictFilter'];
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = `<option value="">${translations.selectProvinceFirst}</option>`;
            select.disabled = true;
        }
    });
    resetMunicipalitySelect();
}

// Reset municipality select
function resetMunicipalitySelect() {
    const selects = ['municipalityFilter', 'mobileMunicipalityFilter'];
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = `<option value="">${translations.selectDistrictFirst}</option>`;
            select.disabled = true;
        }
    });
}

// Load candidates
async function loadCandidates() {
    if (state.isLoading) return;

    state.isLoading = true;

    const params = new URLSearchParams();
    Object.keys(state.filters).forEach(key => {
        if (state.filters[key]) {
            params.set(key, state.filters[key]);
        }
    });

    try {
        // Show loading state
        document.getElementById('candidatesGrid').innerHTML =
            '<div class="loading-skeleton" style="grid-column: 1/-1;">Loading...</div>';

        const response = await fetch(`/api/nearby-candidates/?${params}`);
        const data = await response.json();

        // Filter mock candidates based on position level if using mock data
        let candidates = data.candidates || getMockCandidates();
        if (!data.candidates && state.filters.positionLevel) {
            candidates = candidates.filter(c => c.level === state.filters.positionLevel);
        }

        state.candidates = candidates;
        renderCandidates();
        renderPagination(data.total_pages || 1);

    } catch (error) {
        console.error('Error loading candidates:', error);
        // Filter mock candidates based on position level
        let candidates = getMockCandidates();
        if (state.filters.positionLevel) {
            candidates = candidates.filter(c => c.level === state.filters.positionLevel);
        }
        state.candidates = candidates;
        renderCandidates();
    } finally {
        state.isLoading = false;
    }
}

// Get mock candidates for testing
function getMockCandidates() {
    return [
        {
            id: 1,
            name: 'Ram Prasad Sharma',
            photo: null,
            level: 'federal',
            seatNumber: 'KTM-01',
            party: 'Independent',
            location: 'Kathmandu'
        },
        {
            id: 2,
            name: 'Sita Devi Poudel',
            photo: null,
            level: 'provincial',
            seatNumber: 'BAG-03',
            party: 'Independent',
            location: 'Lalitpur'
        },
        {
            id: 3,
            name: 'Gopal Krishna Shrestha',
            photo: null,
            level: 'local',
            seatNumber: 'Ward-5',
            party: 'Independent',
            location: 'Bhaktapur'
        }
    ];
}

// Update counts (removed level filtering)

// Render candidates
function renderCandidates() {
    const grid = document.getElementById('candidatesGrid');
    const emptyState = document.getElementById('emptyState');
    
    const filteredCandidates = state.candidates;
    
    if (filteredCandidates.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    
    grid.innerHTML = filteredCandidates.map(candidate => `
        <div class="candidate-card">
            <div class="card-header">
                ${candidate.photo ? 
                    `<img src="${candidate.photo}" alt="${candidate.name}" class="candidate-photo">` :
                    `<div class="candidate-photo-placeholder">
                        <i class="fas fa-user"></i>
                    </div>`
                }
                <div class="candidate-info">
                    <h3 class="candidate-name">${candidate.name}</h3>
                    <div class="candidate-details">
                        <div class="detail-row">
                            <span class="level-badge badge-${candidate.level}">${translations[candidate.level] || candidate.level}</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-hashtag"></i>
                            <span>${translations.seat}: ${candidate.seatNumber || translations.na}</span>
                        </div>
                        <div class="detail-row">
                            <span class="party-label">${!candidate.party || candidate.party === 'undefined' ? translations.independent : candidate.party}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-actions">
                <a href="${currentLanguage === 'ne' ? '/ne' : ''}/candidates/${candidate.id}/" class="action-btn primary">
                    <i class="fas fa-user-circle"></i>
                    ${translations.openProfile}
                </a>
                <button class="action-btn" onclick="shareCandidate(${candidate.id}, '${candidate.name}')">
                    <i class="fas fa-share"></i>
                    ${translations.share}
                </button>
            </div>
        </div>
    `).join('');
}

// Render pagination
function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `<button class="page-btn" ${state.filters.page <= 1 ? 'disabled' : ''} 
             onclick="goToPage(${state.filters.page - 1})">
             <i class="fas fa-chevron-left"></i>
             </button>`;
    
    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<button class="page-btn ${i === state.filters.page ? 'active' : ''}" 
                 onclick="goToPage(${i})">${i}</button>`;
    }
    
    // Next button
    html += `<button class="page-btn" ${state.filters.page >= totalPages ? 'disabled' : ''} 
             onclick="goToPage(${state.filters.page + 1})">
             <i class="fas fa-chevron-right"></i>
             </button>`;
    
    pagination.innerHTML = html;
}

// Navigation functions
function goToPage(page) {
    state.filters.page = page;
    updateURL();
    loadCandidates();
}

// Federal filter click handler
function onFederalClick() {
    const federalButton = document.getElementById('federalFilter');

    // Toggle federal state
    if (state.filters.positionLevel === 'federal') {
        // Deactivate federal
        state.filters.positionLevel = '';
        federalButton.style.background = 'white';
        federalButton.style.color = '#374151';

        // Enable province button
        const provinceButton = document.getElementById('provinceButton');
        provinceButton.disabled = false;
        provinceButton.style.background = 'white';
        provinceButton.style.color = '#374151';
        provinceButton.style.cursor = 'pointer';
    } else {
        // Activate federal - disable all other filters
        state.filters.positionLevel = 'federal';
        state.filters.provinceId = '';
        state.filters.districtId = '';
        state.filters.municipalityId = '';
        state.filters.wardNumber = '';
        state.selectedMunicipality = null;

        // Highlight federal button
        federalButton.style.background = '#667eea';
        federalButton.style.color = 'white';

        // Disable and reset province button
        const provinceButton = document.getElementById('provinceButton');
        provinceButton.disabled = true;
        setButtonText('provinceButton', getDefaultLabel('provinceButton'));
        provinceButton.style.background = '#f3f4f6';
        provinceButton.style.color = '#9ca3af';
        provinceButton.style.cursor = 'not-allowed';

        // Disable and reset district button
        const districtButton = document.getElementById('districtButton');
        districtButton.disabled = true;
        setButtonText('districtButton', getDefaultLabel('districtButton'));
        districtButton.style.background = '#f3f4f6';
        districtButton.style.color = '#9ca3af';
        districtButton.style.cursor = 'not-allowed';

        // Disable and reset municipality button
        const municipalityButton = document.getElementById('municipalityButton');
        municipalityButton.disabled = true;
        setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
        municipalityButton.style.background = '#f3f4f6';
        municipalityButton.style.color = '#9ca3af';
        municipalityButton.style.cursor = 'not-allowed';

        // Disable and reset ward button
        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';
        wardButton.style.cursor = 'not-allowed';
    }

    updateURL();
    loadCandidates();
}

// Toggle province dropdown
function toggleProvinceDropdown() {
    const button = document.getElementById('provinceButton');
    if (button.disabled) return; // Don't open if disabled

    const dropdown = document.getElementById('provinceDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Select a province from dropdown
function selectProvince(provinceId, provinceName) {
    const provinceButton = document.getElementById('provinceButton');
    const federalButton = document.getElementById('federalFilter');
    const dropdown = document.getElementById('provinceDropdown');

    // Hide dropdown
    dropdown.style.display = 'none';

    if (provinceId === 'all') {
        // All Provinces selected
        state.filters.positionLevel = 'provincial';
        state.filters.provinceId = 'all';
        state.filters.districtId = '';
        state.filters.municipalityId = '';
        state.filters.wardNumber = '';

        // Update button text
        setButtonText('provinceButton', document.getElementById('provinceButton').dataset.all || 'All');
        provinceButton.style.background = '#667eea';
        provinceButton.style.color = 'white';

        // Disable all other filters
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        const districtButton = document.getElementById('districtButton');
        districtButton.disabled = true;
        setButtonText('districtButton', getDefaultLabel('districtButton'));
        districtButton.style.background = '#f3f4f6';
        districtButton.style.color = '#9ca3af';

        const municipalityButton = document.getElementById('municipalityButton');
        municipalityButton.disabled = true;
        setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
        municipalityButton.style.background = '#f3f4f6';
        municipalityButton.style.color = '#9ca3af';

        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';

    } else if (provinceId) {
        // Specific province selected
        state.filters.positionLevel = '';
        state.filters.provinceId = provinceId;
        state.filters.districtId = '';
        state.filters.municipalityId = '';
        state.filters.wardNumber = '';

        // Update button text
        setButtonText('provinceButton', provinceName);
        provinceButton.style.background = '#667eea';
        provinceButton.style.color = 'white';

        // Disable federal, enable district button
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        const districtButton = document.getElementById('districtButton');
        districtButton.disabled = false;
        setButtonText('districtButton', getDefaultLabel('districtButton'));
        districtButton.style.background = 'white';
        districtButton.style.color = '#374151';

        // Reset municipality and ward
        const municipalityButton = document.getElementById('municipalityButton');
        municipalityButton.disabled = true;
        setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
        municipalityButton.style.background = '#f3f4f6';
        municipalityButton.style.color = '#9ca3af';

        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';

    } else {
        // Clear province selection
        clearProvinceSelection();
    }

    updateURL();
    loadCandidates();
}

// Clear province selection
function clearProvinceSelection() {
    const provinceButton = document.getElementById('provinceButton');
    const federalButton = document.getElementById('federalFilter');

    state.filters.provinceId = '';
    state.filters.districtId = '';
    state.filters.municipalityId = '';
    state.filters.wardNumber = '';

    // Reset button
    setButtonText('provinceButton', getDefaultLabel('provinceButton'));
    provinceButton.style.background = 'white';
    provinceButton.style.color = '#374151';

    // Enable federal button
    federalButton.disabled = false;
    federalButton.style.background = 'white';
    federalButton.style.color = '#374151';

    // Disable and reset district button
    const districtButton = document.getElementById('districtButton');
    districtButton.disabled = true;
    setButtonText('districtButton', getDefaultLabel('districtButton'));
    districtButton.style.background = 'white';
    districtButton.style.color = '#374151';

    // Disable and reset municipality button
    const municipalityButton = document.getElementById('municipalityButton');
    municipalityButton.disabled = true;
    setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
    municipalityButton.style.background = 'white';
    municipalityButton.style.color = '#374151';

    // Disable and reset ward
    document.getElementById('wardFilter').disabled = true;
    document.getElementById('wardFilter').value = '';
}

// Toggle district dropdown
function toggleDistrictDropdown() {
    const button = document.getElementById('districtButton');
    if (button.disabled) return; // Don't open if disabled

    const dropdown = document.getElementById('districtDropdown');
    const districtOptions = document.getElementById('districtOptions');

    // Populate options based on whether province is selected
    if (state.filters.provinceId && state.filters.provinceId !== 'all') {
        // Province is selected - load districts for that province
        loadDistrictsForDropdown(state.filters.provinceId);
    } else {
        // No province selected - show "All Districts" option only
        districtOptions.innerHTML = `
            <div class="province-option" onclick="selectDistrict('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px;">
                <strong>${translations.allDistricts}</strong>
            </div>
        `;
    }

    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Load districts for dropdown
async function loadDistrictsForDropdown(provinceId) {
    const districtOptions = document.getElementById('districtOptions');

    try {
        const response = await fetch(`/api/districts/?province=${provinceId}`);
        const districts = await response.json();

        let html = `
            <div class="province-option" onclick="selectDistrict('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px;">
                <strong>${translations.allDistrictsInProvince}</strong>
            </div>
        `;

        districts.forEach(district => {
            const districtName = currentLanguage === 'ne' ? district.name_ne : district.name_en;
            html += `
                <div class="province-option" onclick="selectDistrict('${district.id}', '${districtName}')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 2px;">
                    ${districtName}
                </div>
            `;
        });

        districtOptions.innerHTML = html;
    } catch (error) {
        console.error('Error loading districts:', error);
        districtOptions.innerHTML = `
            <div class="province-option" onclick="selectDistrict('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px;">
                <strong>${translations.allDistricts}</strong>
            </div>
        `;
    }
}

// Select a district from dropdown
function selectDistrict(districtId, districtName) {
    const districtButton = document.getElementById('districtButton');
    const federalButton = document.getElementById('federalFilter');
    const provinceButton = document.getElementById('provinceButton');
    const dropdown = document.getElementById('districtDropdown');

    // Hide dropdown
    dropdown.style.display = 'none';

    if (districtId === 'all') {
        // All Districts selected
        if (state.filters.provinceId && state.filters.provinceId !== 'all') {
            // All districts in specific province
            state.filters.positionLevel = 'district';
            state.filters.districtId = 'all';
            setButtonText('districtButton', translations.allDistrictsInProvince);
        } else {
            // All districts nationwide
            state.filters.positionLevel = 'district';
            state.filters.provinceId = '';
            state.filters.districtId = 'all';
            setButtonText('districtButton', document.getElementById('districtButton').dataset.all || translations.allDistricts);
        }

        districtButton.style.background = '#667eea';
        districtButton.style.color = 'white';

        // Disable other filters
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        if (!state.filters.provinceId) {
            provinceButton.disabled = true;
            provinceButton.style.background = '#f3f4f6';
            provinceButton.style.color = '#9ca3af';
        }

        const municipalityButton = document.getElementById('municipalityButton');
        municipalityButton.disabled = true;
        setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
        municipalityButton.style.background = '#f3f4f6';
        municipalityButton.style.color = '#9ca3af';

        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';

    } else if (districtId) {
        // Specific district selected
        state.filters.positionLevel = '';
        state.filters.districtId = districtId;

        setButtonText('districtButton', districtName);
        districtButton.style.background = '#667eea';
        districtButton.style.color = 'white';

        // Disable federal, enable municipality
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        // Enable municipality button
        const municipalityButton = document.getElementById('municipalityButton');
        municipalityButton.disabled = false;
        setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
        municipalityButton.style.background = 'white';
        municipalityButton.style.color = '#374151';

    } else {
        // Clear district selection
        clearDistrictSelection();
    }

    // Reset downstream filters
    state.filters.municipalityId = '';
    state.filters.wardNumber = '';

    updateURL();
    loadCandidates();
}

// Clear district selection
function clearDistrictSelection() {
    const districtButton = document.getElementById('districtButton');
    const federalButton = document.getElementById('federalFilter');
    const provinceButton = document.getElementById('provinceButton');

    state.filters.districtId = '';
    state.filters.municipalityId = '';
    state.filters.wardNumber = '';

    // Reset button
    districtButton.textContent = 'District';
    districtButton.style.background = 'white';
    districtButton.style.color = '#374151';

    // Enable federal if no province selected
    if (!state.filters.provinceId) {
        federalButton.disabled = false;
        federalButton.style.background = 'white';
        federalButton.style.color = '#374151';
    }

    // Disable and reset downstream filters
    document.getElementById('municipalityFilter').disabled = true;
    document.getElementById('municipalityFilter').innerHTML = '<option value="">Municipality</option>';
    document.getElementById('wardFilter').disabled = true;
    document.getElementById('wardFilter').value = '';
}

// Toggle municipality dropdown
function toggleMunicipalityDropdown() {
    const button = document.getElementById('municipalityButton');
    if (button.disabled) return; // Don't open if disabled

    const dropdown = document.getElementById('municipalityDropdown');
    const municipalityOptions = document.getElementById('municipalityOptions');

    // Check if both province and district are selected
    if (state.filters.districtId && state.filters.districtId !== 'all') {
        // District is selected - load municipalities for that district
        loadMunicipalitiesForDropdown(state.filters.districtId);
    } else {
        // No district selected - show "All Municipalities" option only
        municipalityOptions.innerHTML = `
            <div class="province-option" onclick="selectMunicipality('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px;">
                <strong>${translations.allMunicipalities}</strong>
            </div>
            <div style="padding: 8px 12px; color: #9ca3af; font-size: 0.9em;">
                ${translations.selectProvinceDistrictFirst}
            </div>
        `;
    }

    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Load municipalities for dropdown
async function loadMunicipalitiesForDropdown(districtId) {
    const municipalityOptions = document.getElementById('municipalityOptions');

    try {
        const response = await fetch(`/api/municipalities/?district=${districtId}`);
        const municipalities = await response.json();

        let html = `
            <div class="province-option" onclick="selectMunicipality('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px;">
                <strong>${translations.allMunicipalitiesInDistrict}</strong>
            </div>
        `;

        municipalities.forEach(municipality => {
            const municipalityName = currentLanguage === 'ne' ? municipality.name_ne : municipality.name_en;
            html += `
                <div class="province-option" onclick="selectMunicipality('${municipality.id}', '${municipalityName}', ${municipality.total_wards})" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 2px;">
                    ${municipalityName}
                </div>
            `;
        });

        municipalityOptions.innerHTML = html;
    } catch (error) {
        console.error('Error loading municipalities:', error);
        municipalityOptions.innerHTML = `
            <div class="province-option" onclick="selectMunicipality('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px;">
                <strong>${translations.allMunicipalities}</strong>
            </div>
        `;
    }
}

// Select a municipality from dropdown
function selectMunicipality(municipalityId, municipalityName, totalWards) {
    const municipalityButton = document.getElementById('municipalityButton');
    const federalButton = document.getElementById('federalFilter');
    const provinceButton = document.getElementById('provinceButton');
    const districtButton = document.getElementById('districtButton');
    const dropdown = document.getElementById('municipalityDropdown');

    // Hide dropdown
    dropdown.style.display = 'none';

    if (municipalityId === 'all') {
        // All Municipalities selected
        if (state.filters.districtId && state.filters.districtId !== 'all') {
            // All municipalities in specific district
            state.filters.positionLevel = 'municipality';
            state.filters.municipalityId = 'all';
            setButtonText('municipalityButton', translations.allMunicipalitiesInDistrict);
        } else {
            // All municipalities nationwide
            state.filters.positionLevel = 'municipality';
            state.filters.provinceId = '';
            state.filters.districtId = '';
            state.filters.municipalityId = 'all';
            setButtonText('municipalityButton', document.getElementById('municipalityButton').dataset.all || translations.allMunicipalities);
        }

        municipalityButton.style.background = '#667eea';
        municipalityButton.style.color = 'white';

        // Clear selected municipality data
        state.selectedMunicipality = null;

        // Disable other filters
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        if (!state.filters.districtId) {
            provinceButton.disabled = true;
            provinceButton.style.background = '#f3f4f6';
            provinceButton.style.color = '#9ca3af';

            districtButton.disabled = true;
            districtButton.style.background = '#f3f4f6';
            districtButton.style.color = '#9ca3af';
        }

        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';

    } else if (municipalityId) {
        // Specific municipality selected
        state.filters.positionLevel = '';
        state.filters.municipalityId = municipalityId;

        // Store municipality data with total_wards
        state.selectedMunicipality = {
            id: municipalityId,
            name: municipalityName,
            total_wards: totalWards || 5  // Default to 5 if not provided
        };

        setButtonText('municipalityButton', municipalityName);
        municipalityButton.style.background = '#667eea';
        municipalityButton.style.color = 'white';

        // Disable federal, enable ward button
        federalButton.disabled = true;
        federalButton.style.background = '#f3f4f6';
        federalButton.style.color = '#9ca3af';

        const wardButton = document.getElementById('wardButton');
        wardButton.disabled = false;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = 'white';
        wardButton.style.color = '#374151';

        // Pre-load ward dropdown with the total_wards data
        loadWardsForDropdown();

    } else {
        // Clear municipality selection
        clearMunicipalitySelection();
    }

    // Reset ward filter
    state.filters.wardNumber = '';
    const wardButton = document.getElementById('wardButton');
    if (wardButton && municipalityId !== 'all') {
        setButtonText('wardButton', getDefaultLabel('wardButton'));
    }

    updateURL();
    loadCandidates();
}

// Clear municipality selection
function clearMunicipalitySelection() {
    const municipalityButton = document.getElementById('municipalityButton');
    const federalButton = document.getElementById('federalFilter');

    state.filters.municipalityId = '';
    state.filters.wardNumber = '';
    state.selectedMunicipality = null;  // Clear stored municipality data

    // Reset button
    setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
    municipalityButton.style.background = 'white';
    municipalityButton.style.color = '#374151';

    // Enable federal if no other filters
    if (!state.filters.provinceId && !state.filters.districtId) {
        federalButton.disabled = false;
        federalButton.style.background = 'white';
        federalButton.style.color = '#374151';
    }

    // Disable and reset ward button
    const wardButton = document.getElementById('wardButton');
    if (wardButton) {
        wardButton.disabled = true;
        setButtonText('wardButton', getDefaultLabel('wardButton'));
        wardButton.style.background = '#f3f4f6';
        wardButton.style.color = '#9ca3af';
    }
}

// Toggle ward dropdown
function toggleWardDropdown() {
    const button = document.getElementById('wardButton');
    if (button.disabled) return; // Don't open if disabled

    const dropdown = document.getElementById('wardDropdown');
    const wardOptions = document.getElementById('wardOptions');

    // Check if municipality is selected
    if (state.filters.municipalityId && state.filters.municipalityId !== 'all') {
        // Municipality is selected - load wards for that municipality
        loadWardsForDropdown();
    } else {
        // No municipality selected - show message
        wardOptions.innerHTML = `
            <div style="padding: 8px 12px; color: #9ca3af; font-size: 0.9em;">
                ${translations.selectProvDistMuniFirst}
            </div>
        `;
    }

    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Load wards for selected municipality
function loadWardsForDropdown() {
    const wardOptions = document.getElementById('wardOptions');

    // Use stored municipality data to get total wards
    let totalWards = 5; // Default if no data
    if (state.selectedMunicipality && state.selectedMunicipality.total_wards) {
        totalWards = state.selectedMunicipality.total_wards;
    }

    let html = `
        <div class="province-option" onclick="selectWard('all')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px;">
            <strong>${translations.allWards}</strong>
        </div>
    `;

    // Generate ward options from 1 to total_wards
    for (let i = 1; i <= totalWards; i++) {
        html += `
            <div class="province-option" onclick="selectWard('${i}')" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 2px;">
                ${translations.ward} ${i}
            </div>
        `;
    }

    wardOptions.innerHTML = html;
}

// Select a ward from dropdown
function selectWard(wardNumber) {
    const wardButton = document.getElementById('wardButton');
    const federalButton = document.getElementById('federalFilter');
    const dropdown = document.getElementById('wardDropdown');

    // Hide dropdown
    dropdown.style.display = 'none';

    if (wardNumber === 'all') {
        // All Wards selected
        state.filters.wardNumber = 'all';
        setButtonText('wardButton', document.getElementById('wardButton').dataset.all || 'All Wards');
        wardButton.style.background = '#667eea';
        wardButton.style.color = 'white';
    } else if (wardNumber) {
        // Specific ward selected
        state.filters.wardNumber = wardNumber;
        const wardPrefix = document.getElementById('wardButton').dataset.wardPrefix || 'Ward';
        setButtonText('wardButton', `${wardPrefix} ${wardNumber}`);
        wardButton.style.background = '#667eea';
        wardButton.style.color = 'white';
    } else {
        // Clear ward selection
        clearWardSelection();
        return;
    }

    // Keep federal disabled when ward is selected
    federalButton.disabled = true;
    federalButton.style.background = '#f3f4f6';
    federalButton.style.color = '#9ca3af';

    updateURL();
    loadCandidates();
}

// Clear ward selection
function clearWardSelection() {
    const wardButton = document.getElementById('wardButton');
    const federalButton = document.getElementById('federalFilter');

    state.filters.wardNumber = '';

    // Reset button
    setButtonText('wardButton', getDefaultLabel('wardButton'));
    wardButton.style.background = 'white';
    wardButton.style.color = '#374151';

    // Enable federal if no other filters
    if (!state.filters.provinceId && !state.filters.districtId && !state.filters.municipalityId) {
        federalButton.disabled = false;
        federalButton.style.background = 'white';
        federalButton.style.color = '#374151';
    }
}

// Load districts for a specific select element
async function loadDistrictsForSelect(provinceId, selectId) {
    if (!provinceId) return;

    try {
        const response = await fetch(`/api/districts/?province=${provinceId}`);
        const districts = await response.json();

        const districtOptions = districts.map(d =>
            `<option value="${d.id}">${currentLanguage === 'ne' ? d.name_ne : d.name_en}</option>`
        ).join('');

        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = `<option value="">${translations.selectDistrict}</option>` + districtOptions;
        }
    } catch (error) {
        console.error('Error loading districts:', error);
    }
}

// Load municipalities for a specific select element
async function loadMunicipalitiesForSelect(districtId, selectId) {
    if (!districtId) return;

    try {
        const response = await fetch(`/api/municipalities/?district=${districtId}`);
        const municipalities = await response.json();

        const municipalityOptions = municipalities.map(m =>
            `<option value="${m.id}">${currentLanguage === 'ne' ? m.name_ne : m.name_en}</option>`
        ).join('');

        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = `<option value="">${translations.selectMunicipality}</option>` + municipalityOptions;
        }
    } catch (error) {
        console.error('Error loading municipalities:', error);
    }
}


// Search functions
function setupSearchDebounce() {
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        clearTimeout(state.debounceTimer);
        state.debounceTimer = setTimeout(() => {
            state.filters.q = e.target.value;
            state.filters.page = 1;
            updateURL();
            loadCandidates();
        }, 300);
    });
}

function performSearch() {
    const searchInput = document.getElementById('searchInput');
    state.filters.q = searchInput.value;
    state.filters.page = 1;
    updateURL();
    loadCandidates();
}

// Apply filters when ward number changes
function applyFilters() {
    const wardInput = document.getElementById('wardFilter');
    if (wardInput) {
        state.filters.wardNumber = wardInput.value;
    }
    updateURL();
    loadCandidates();
}

// Clear functions
function clearLocationFilters() {
    state.filters.provinceId = '';
    state.filters.districtId = '';
    state.filters.municipalityId = '';
    state.filters.wardNumber = '';

    document.getElementById('provinceFilter').value = '';
    document.getElementById('mobileProvinceFilter').value = '';
    const wardInput = document.getElementById('wardFilter');
    if (wardInput) wardInput.value = '';

    resetDistrictSelect();
    resetMunicipalitySelect();

    updateURL();
    loadCandidates();
}

function clearAllFilters() {
    state.filters = {
        positionLevel: '',
        provinceId: '',
        districtId: '',
        municipalityId: '',
        wardNumber: '',
        q: '',
        page: 1
    };

    // Clear search input
    document.getElementById('searchInput').value = '';

    // Reset federal button
    const federalButton = document.getElementById('federalFilter');
    federalButton.disabled = false;
    federalButton.style.background = 'white';
    federalButton.style.color = '#374151';

    // Reset province button
    const provinceButton = document.getElementById('provinceButton');
    provinceButton.textContent = 'Province';
    provinceButton.style.background = 'white';
    provinceButton.style.color = '#374151';
    provinceButton.disabled = false;

    // Reset district button
    const districtButton = document.getElementById('districtButton');
    districtButton.textContent = 'District';
    districtButton.style.background = 'white';
    districtButton.style.color = '#374151';
    districtButton.disabled = false;

    // Reset municipality button
    const municipalityButton = document.getElementById('municipalityButton');
    setButtonText('municipalityButton', getDefaultLabel('municipalityButton'));
    municipalityButton.style.background = 'white';
    municipalityButton.style.color = '#374151';
    municipalityButton.disabled = false;

    // Reset ward button
    const wardButton = document.getElementById('wardButton');
    setButtonText('wardButton', getDefaultLabel('wardButton'));
    wardButton.style.background = 'white';
    wardButton.style.color = '#374151';
    wardButton.disabled = false;

    updateURL();
    loadCandidates();
}

// Share function
async function shareCandidate(candidateId, candidateName) {
    const url = `${window.location.origin}/candidates/${candidateId}/`;
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: `${candidateName} - ElectNepal`,
                text: `Check out ${candidateName}'s profile on ElectNepal`,
                url: url
            });
        } catch (err) {
            console.log('Share cancelled or failed');
        }
    } else {
        // Fallback: copy to clipboard
        try {
            await navigator.clipboard.writeText(url);
            alert('Profile link copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy:', err);
        }
    }
}

// Mobile drawer functions
function openFilterDrawer() {
    document.getElementById('filterDrawer').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeFilterDrawer() {
    document.getElementById('filterDrawer').classList.remove('open');
    document.body.style.overflow = '';
}
</script>
{% endblock %}