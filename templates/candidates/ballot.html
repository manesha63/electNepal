{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "Ballot" %} - ElectNepal{% endblock %}

{% block extra_css %}
<style>
    .ballot-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .ballot-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .ballot-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 1rem;
    }

    .ballot-subtitle {
        font-size: 1.125rem;
        color: #4a5568;
        margin-bottom: 2rem;
    }

    .location-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.125rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .location-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .location-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .manual-selection {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .form-select {
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.2s;
    }

    .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-input {
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-button {
        padding: 0.75rem 2rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-button:hover {
        background: #5a67d8;
    }

    /* Grid container for cards - adjusted to match location box */
    .candidates-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 0;
        max-width: 100%;
        margin: 2rem 0;
    }

    @media (max-width: 1024px) {
        .candidates-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .candidates-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Candidate Card - WeVote style (exact copy from main page) */
    .candidate-card {
        background: linear-gradient(to bottom, #EBEBEB, #EDEDED);
        border: 1px solid #E6E6E6;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        cursor: pointer;
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    .candidate-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        background: linear-gradient(to bottom, #F3F4F6, #E5E7EB);
    }

    .card-header {
        width: 100%;
    }

    .candidate-photo {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .candidate-photo-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #E2E2E2, #D1D5DB);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        font-size: 3rem;
    }

    .candidate-info {
        flex: 1;
        padding: 16px;
        text-align: center;
    }

    .candidate-name-link {
        text-decoration: none;
        display: block;
    }

    .candidate-name-link:hover .candidate-name {
        color: #60A5FA;
    }

    .candidate-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 8px;
        cursor: pointer;
        transition: color 0.2s;
    }

    .candidate-office {
        font-size: 1rem;
        color: #1F2937;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .candidate-seat {
        font-size: 0.875rem;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .candidate-location {
        font-size: 0.875rem;
        color: #4B5563;
        margin-top: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-weight: 500;
    }

    .candidate-location i {
        font-size: 0.625rem;
    }

    .card-actions {
        padding: 12px 16px 16px;
        margin-top: auto;
        text-align: center;
    }

    .action-btn {
        background: none;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: #6B7280;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
    }

    .action-btn:hover {
        color: #60A5FA;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .relevance-indicator {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: #edf2f7;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .relevance-ward {
        background: #bee3f8;
        color: #2c5282;
    }

    .relevance-municipality {
        background: #c6f6d5;
        color: #22543d;
    }

    .relevance-district {
        background: #fed7d7;
        color: #742a2a;
    }

    .relevance-province {
        background: #feebc8;
        color: #7c2d12;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #e2e8f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-message {
        background: #fed7d7;
        border: 1px solid #fc8181;
        color: #742a2a;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .info-message {
        background: #bee3f8;
        border: 1px solid #90cdf4;
        color: #2c5282;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .divider {
        display: flex;
        align-items: center;
        margin: 2rem 0;
        color: #a0aec0;
    }

    .divider::before,
    .divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e2e8f0;
    }

    .divider span {
        padding: 0 1rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
{% get_current_language as LANGUAGE_CODE %}
<div class="ballot-container" x-data="ballotApp()" x-init="currentLanguage = '{{ LANGUAGE_CODE }}'; requestLocation()">
    <!-- Loading state while getting location -->
    <template x-if="loading && !error">
        <div class="text-center py-8">
            <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
            <p class="mt-4 text-lg text-gray-600">{% trans "Finding candidates in your area..." %}</p>
            <p class="mt-2 text-sm text-gray-500">{% trans "Please allow location access when prompted" %}</p>
        </div>
    </template>

    <!-- Error message -->
    <template x-if="error">
        <div class="error-message" x-text="error"></div>
    </template>

    <!-- Manual selection -->
    <template x-if="!loading || error">
        <div class="divider">
            <span>{% trans "SELECT LOCATION MANUALLY" %}</span>
        </div>
    </template>

    <div class="manual-selection" x-show="!loading || error">
        <h3 class="text-lg font-semibold mb-4">{% trans "Select Your Location" %}</h3>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">{% trans "Province" %}</label>
                <select
                    class="form-select"
                    x-model="selectedProvince"
                    @change="loadDistricts()">
                    <option value="">{% trans "Select Province" %}</option>
                    {% for province in provinces %}
                    <option value="{{ province.id }}">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% if LANGUAGE_CODE == 'ne' %}{{ province.name_ne }}{% else %}{{ province.name_en }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">{% trans "District" %}</label>
                <select
                    class="form-select"
                    x-model="selectedDistrict"
                    @change="loadMunicipalities()"
                    :disabled="!districts.length">
                    <option value="">{% trans "Select District" %}</option>
                    <template x-for="district in districts" :key="district.id">
                        {% get_current_language as LANGUAGE_CODE %}
                        <option :value="district.id" x-text="{% if LANGUAGE_CODE == 'ne' %}district.name_ne{% else %}district.name_en{% endif %}"></option>
                    </template>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">{% trans "Municipality" %}</label>
                <select
                    class="form-select"
                    x-model="selectedMunicipality"
                    @change="updateWardLimit()"
                    :disabled="!municipalities.length">
                    <option value="">{% trans "Select Municipality" %}</option>
                    <template x-for="muni in municipalities" :key="muni.id">
                        {% get_current_language as LANGUAGE_CODE %}
                        <option :value="muni.id" x-text="{% if LANGUAGE_CODE == 'ne' %}muni.name_ne{% else %}muni.name_en{% endif %}"></option>
                    </template>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">{% trans "Ward Number" %} <span style="color: red;">*</span></label>
                <input
                    type="number"
                    class="form-input"
                    x-model="selectedWard"
                    :max="maxWards"
                    required
                    min="1"
                    placeholder="{% trans 'Enter ward number' %}">
            </div>
        </div>

        <button
            @click="searchManual()"
            class="search-button"
            :disabled="!selectedProvince || !selectedWard">
            {% trans "Search Candidates" %}
        </button>
    </div>

    <!-- Results section -->
    <template x-if="candidates.length > 0 && !loading">
        <div>
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">{% trans "Your Ballot" %}</h1>
                <p class="text-lg text-gray-600">
                    <span x-text="totalCandidates"></span> {% trans "independent candidates in your voting area" %}
                    <template x-if="totalPages > 1">
                        <span class="text-sm text-gray-500">
                            ({% trans "Page" %} <span x-text="currentPage"></span> {% trans "of" %} <span x-text="totalPages"></span>)
                        </span>
                    </template>
                </p>
            </div>

            <!-- Candidates Grid - same as main page -->
            <div class="candidates-grid">
                <template x-for="candidate in candidates" :key="candidate.id">
                    <div class="candidate-card" @click="window.location.href = candidate.detail_url">
                        <!-- Relevance indicator overlay -->
                        <template x-if="candidate.ward === parseInt(selectedWard) && candidate.municipality_id === parseInt(selectedMunicipality)">
                            <span class="relevance-indicator relevance-ward" style="position: absolute; top: 10px; left: 10px; z-index: 10;">{% trans "Your Ward" %}</span>
                        </template>
                        <template x-if="candidate.municipality_id === parseInt(selectedMunicipality) && candidate.ward !== parseInt(selectedWard)">
                            <span class="relevance-indicator relevance-municipality" style="position: absolute; top: 10px; left: 10px; z-index: 10;">{% trans "Your Municipality" %}</span>
                        </template>
                        <template x-if="candidate.district_id === parseInt(selectedDistrict) && candidate.municipality_id !== parseInt(selectedMunicipality)">
                            <span class="relevance-indicator relevance-district" style="position: absolute; top: 10px; left: 10px; z-index: 10;">{% trans "Your District" %}</span>
                        </template>
                        <template x-if="candidate.province_id === parseInt(selectedProvince) && candidate.district_id !== parseInt(selectedDistrict)">
                            <span class="relevance-indicator relevance-province" style="position: absolute; top: 10px; left: 10px; z-index: 10;">{% trans "Your Province" %}</span>
                        </template>

                        <!-- Exact template from main page -->
                        <div class="card-header">
                            <template x-if="candidate.photo">
                                <img :src="candidate.photo" :alt="candidate.name" class="candidate-photo">
                            </template>
                            <template x-if="!candidate.photo">
                                <div class="candidate-photo-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            </template>
                        </div>
                        <div class="candidate-info">
                            <a :href="candidate.detail_url" class="candidate-name-link">
                                <h3 class="candidate-name" x-text="candidate.name"></h3>
                            </a>
                            <div class="candidate-office">
                                <span>{% trans "Office:" %} </span><span x-text="getOfficeTitle(candidate.position_level)"></span>
                            </div>
                            <div class="candidate-seat">
                                <span>{% trans "Seat:" %} </span><span x-text="getSeatDescription(candidate.position_level)"></span>
                            </div>
                            <div class="candidate-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span style="display: inline;">{% trans "From:" %} <span x-text="formatLocation(candidate)"></span></span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="action-btn" @click.stop="shareCandidate(candidate.id)">
                                <i class="fas fa-share"></i>
                                {% trans "Share" %}
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Pagination Controls -->
            <!-- Pagination Controls -->
            <template x-if="totalPages > 1">
                <div class="pagination-controls" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 30px 0;">
                    <!-- Show appropriate navigation based on page position -->
                    <template x-if="currentPage === 1 && hasNext">
                        <!-- First page with more pages: show > only -->
                        <button
                            @click="nextPage()"
                            class="px-6 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                            style="display: flex; align-items: center;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </template>

                    <template x-if="currentPage > 1 && hasNext">
                        <!-- Middle pages: show < > -->
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <button
                                @click="previousPage()"
                                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                                style="display: flex; align-items: center;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button
                                @click="nextPage()"
                                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                                style="display: flex; align-items: center;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </template>

                    <template x-if="currentPage > 1 && !hasNext">
                        <!-- Last page: show << only -->
                        <button
                            @click="previousPage()"
                            class="px-6 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                            style="display: flex; align-items: center;">
                            <i class="fas fa-chevron-double-left"></i>
                        </button>
                    </template>
                </div>
            </template>
        </div>
    </template>

    <template x-if="searched && candidates.length === 0 && !loading">
        <div class="text-center py-8">
            <div class="info-message">
                <h3 class="text-xl font-semibold mb-2">{% trans "No Candidates Found" %}</h3>
                <p>{% trans "No independent candidates are currently registered in your area." %}</p>
                <p class="mt-2">{% trans "Try selecting a different location or check back later." %}</p>
            </div>
        </div>
    </template>
</div>

<script src="{% static 'js/position-utils.js' %}"></script>
<script>
function ballotApp() {
    return {
        loading: false,
        error: null,
        searched: false,
        candidates: [],
        currentLanguage: 'en',  // Will be set in x-init

        // Pagination data
        currentPage: 1,
        totalPages: 1,
        totalCandidates: 0,
        pageSize: 20,
        hasNext: false,
        hasPrevious: false,

        // Location selection
        selectedProvince: '',
        selectedDistrict: '',
        selectedMunicipality: '',
        selectedWard: '',

        // Dropdown data
        districts: [],
        municipalities: [],
        maxWards: 50,

        // Request user's location
        async requestLocation() {
            this.loading = true;
            this.error = null;

            if (!navigator.geolocation) {
                this.error = "{% trans 'Geolocation is not supported by your browser.' %}";
                this.loading = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    await this.resolveLocation(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    this.loading = false;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            this.error = "{% trans 'Location permission denied. Please select your location manually.' %}";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            this.error = "{% trans 'Location information unavailable. Please select manually.' %}";
                            break;
                        case error.TIMEOUT:
                            this.error = "{% trans 'Location request timed out. Please try again.' %}";
                            break;
                        default:
                            this.error = "{% trans 'Unable to get your location. Please select manually.' %}";
                    }
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        },

        // Resolve coordinates to location
        async resolveLocation(lat, lng) {
            try {
                const response = await fetch(`/api/georesolve/?lat=${lat}&lng=${lng}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "{% trans 'Could not determine location' %}");
                }

                // Set location from resolved data
                if (data.province) {
                    this.selectedProvince = data.province.id;
                    await this.loadDistricts();
                }

                if (data.district) {
                    this.selectedDistrict = data.district.id;
                    await this.loadMunicipalities();
                }

                if (data.municipality) {
                    this.selectedMunicipality = data.municipality.id;
                    await this.updateWardLimit();
                }

                if (data.ward_number) {
                    this.selectedWard = data.ward_number;
                }

                // Load candidates
                await this.loadCandidates();

            } catch (error) {
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        },

        // Load districts for selected province
        async loadDistricts() {
            if (!this.selectedProvince) {
                this.districts = [];
                return;
            }

            try {
                const response = await fetch(`/api/districts/?province=${this.selectedProvince}`);
                this.districts = await response.json();
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        },

        // Load municipalities for selected district
        async loadMunicipalities() {
            if (!this.selectedDistrict) {
                this.municipalities = [];
                return;
            }

            try {
                const response = await fetch(`/api/municipalities/?district=${this.selectedDistrict}`);
                this.municipalities = await response.json();
            } catch (error) {
                console.error('Error loading municipalities:', error);
            }
        },

        // Update ward limit based on selected municipality
        async updateWardLimit() {
            if (!this.selectedMunicipality) {
                this.maxWards = 50;
                return;
            }

            const muni = this.municipalities.find(m => m.id == this.selectedMunicipality);
            if (muni) {
                this.maxWards = muni.total_wards || 50;
            }
        },

        // Search manually with selected location
        async searchManual() {
            if (!this.selectedProvince) {
                this.error = "{% trans 'Please select a province' %}";
                return;
            }
            if (!this.selectedWard) {
                this.error = "{% trans 'Please enter a ward number' %}";
                return;
            }

            await this.loadCandidates();
        },

        // Load candidates based on location with frontend caching and pagination
        async loadCandidates(page = 1) {
            this.loading = true;
            this.error = null;

            // Create cache key for localStorage including page
            const cacheKey = `ballot_${this.selectedProvince || ''}_${this.selectedDistrict || ''}_${this.selectedMunicipality || ''}_${this.selectedWard || ''}_${document.documentElement.lang || 'en'}_page${page}`;

            // Try to get cached data (valid for 5 minutes)
            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const cached = JSON.parse(cachedData);
                    const cacheAge = Date.now() - cached.timestamp;

                    // If cache is less than 5 minutes old (300000 ms), use it
                    if (cacheAge < 300000) {
                        const data = cached.data;
                        this.candidates = data.candidates || [];
                        this.currentPage = data.page || 1;
                        this.totalPages = data.num_pages || 1;
                        this.totalCandidates = data.total || 0;
                        this.hasNext = data.has_next || false;
                        this.hasPrevious = data.has_previous || false;
                        this.searched = true;
                        this.loading = false;
                        console.log('Using cached ballot data for page', page);
                        return;
                    }
                } catch (e) {
                    // Invalid cache data, remove it
                    localStorage.removeItem(cacheKey);
                }
            }

            const params = new URLSearchParams({
                province_id: this.selectedProvince || '',
                district_id: this.selectedDistrict || '',
                municipality_id: this.selectedMunicipality || '',
                ward_number: this.selectedWard || '',
                page: page,
                page_size: this.pageSize
            });

            try {
                const response = await fetch(`/candidates/api/my-ballot/?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "{% trans 'Failed to load candidates' %}");
                }

                this.candidates = data.candidates || [];
                this.currentPage = data.page || 1;
                this.totalPages = data.num_pages || 1;
                this.totalCandidates = data.total || 0;
                this.hasNext = data.has_next || false;
                this.hasPrevious = data.has_previous || false;
                this.searched = true;

                // Cache the successful result
                try {
                    localStorage.setItem(cacheKey, JSON.stringify({
                        timestamp: Date.now(),
                        data: data
                    }));

                    // Clean up old cache entries (keep only last 10)
                    this.cleanupOldCache();
                } catch (e) {
                    // localStorage might be full or disabled
                    console.warn('Could not cache ballot data:', e);
                }

            } catch (error) {
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        },

        // Navigate to next page
        async nextPage() {
            if (this.hasNext) {
                await this.loadCandidates(this.currentPage + 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        // Navigate to previous page
        async previousPage() {
            if (this.hasPrevious) {
                await this.loadCandidates(this.currentPage - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        // Navigate to specific page
        async goToPage(pageNumber) {
            if (pageNumber >= 1 && pageNumber <= this.totalPages) {
                await this.loadCandidates(pageNumber);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        // Clean up old ballot cache entries
        cleanupOldCache() {
            const ballotKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('ballot_')) {
                    ballotKeys.push(key);
                }
            }

            // If more than 10 ballot caches, remove oldest ones
            if (ballotKeys.length > 10) {
                const keysWithTime = ballotKeys.map(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        return { key, timestamp: data.timestamp || 0 };
                    } catch {
                        return { key, timestamp: 0 };
                    }
                });

                keysWithTime.sort((a, b) => a.timestamp - b.timestamp);
                const toRemove = keysWithTime.slice(0, keysWithTime.length - 10);
                toRemove.forEach(item => localStorage.removeItem(item.key));
            }
        },

        // Helper functions for displaying candidate cards
        formatLocation(candidate) {
            const parts = [];
            // Ward should be an integer, display as "Ward X"
            if (candidate.ward && typeof candidate.ward === 'number') {
                const wardLabel = "{% trans 'Ward' %}";
                parts.push(`${wardLabel} ${candidate.ward}`);
            }
            // Municipality, District, Province should be strings
            if (candidate.municipality && typeof candidate.municipality === 'string') {
                parts.push(candidate.municipality);
            }
            if (candidate.district && typeof candidate.district === 'string') {
                parts.push(candidate.district);
            }
            // Don't show province for federal candidates as it's redundant
            if (candidate.province && typeof candidate.province === 'string' && candidate.position_level !== 'federal') {
                parts.push(candidate.province);
            }
            return parts.join(', ') || 'Nepal';
        },

        getOfficeTitle(position_level) {
            const translations = {
                ward: "{% trans 'Ward' %}",
                municipalityRural: "{% trans 'Municipality/Rural Municipality' %}",
                provincialAssembly: "{% trans 'Provincial Assembly' %}",
                federalParliament: "{% trans 'Federal Parliament' %}",
                localGovernment: "{% trans 'Local Government' %}"
            };
            return PositionUtils.getOfficeTitle(position_level, translations);
        },

        getSeatDescription(position_level) {
            const translations = {
                wardChairperson: "{% trans 'Ward Chairperson' %}",
                wardMember: "{% trans 'Ward Member' %}",
                mayorChairperson: "{% trans 'Mayor/Chairperson' %}",
                deputyMayorViceChairperson: "{% trans 'Deputy Mayor/Vice Chairperson' %}",
                provincialAssemblyMember: "{% trans 'Provincial Assembly Member' %}",
                houseRepresentativesMember: "{% trans 'House of Representatives Member' %}",
                nationalAssemblyMember: "{% trans 'National Assembly Member' %}",
                memberParliament: "{% trans 'Member of Parliament' %}",
                localRepresentative: "{% trans 'Local Representative' %}",
                wardRepresentative: "{% trans 'Ward Representative' %}"
            };
            return PositionUtils.getSeatDescription(position_level, translations);
        },

        shareCandidate(candidateId) {
            const shareUrl = `${window.location.origin}/candidates/${candidateId}/`;
            const shareText = "{% trans 'Check out this independent candidate' %}";

            if (navigator.share) {
                navigator.share({
                    title: shareText,
                    url: shareUrl
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback to copying URL
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert("{% trans 'Link copied to clipboard!' %}");
                }).catch(err => {
                    alert("{% trans 'Could not copy link' %}");
                });
            }
        }
    }
}
</script>
{% endblock %}